name: Generate README

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'README.template.md'
      - 'Backend/**'
      - '.github/workflows/update-structure.yml'

jobs:
  build:
    name: Generate README
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install tree
        run: sudo apt-get update && sudo apt-get install -y tree

      - name: Generate project tree file
        run: tree Backend -L 3 --dirsfirst -I 'bin|obj|.vs|Properties' > project_tree.txt

      - name: Generate README.md from template
        run: |
          python -c "
          # Lê o conteúdo do template e da árvore gerada
          with open('README.template.md', 'r') as f: template_content = f.read()
          with open('project_tree.txt', 'r') as f: tree_content = f.read()
          
          # Prepara o bloco de código da árvore
          tree_block = f'```\n{tree_content}```'
          
          # Lógica de substituição segura: troca o placeholder pelo bloco da árvore
          new_readme = template_content.replace('{{project_tree}}', tree_block)
          
          # Escreve o resultado em um NOVO (ou sobrescreve o antigo) README.md
          with open('README.md', 'w') as f:
              f.write(new_readme)
          "

      - name: Commit and push generated README.md
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: generate and update README.md from template"
          file_pattern: README.md
